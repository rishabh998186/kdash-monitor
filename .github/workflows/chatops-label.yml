name: ChatOps Label
on:
  repository_dispatch:
    types: [label-command, remove-label-command]
permissions:
  issues: write
  pull-requests: write
  contents: read
jobs:
  label:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Handle Labeling
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const yaml = require('js-yaml');
            const payload = context.payload.client_payload;
            const command = payload.slash_command.command;
            const label = payload.slash_command.args.all.trim();
            const issueNumber = payload.github.payload.issue?.number || payload.github.payload.pull_request?.number;
            
            if (!issueNumber) {
              core.setFailed('Could not determine issue/PR number');
              return;
            }
            
            // Load and validate label
            const prowLabels = yaml.load(fs.readFileSync('.prowlabels.yaml', 'utf8'));
            const validLabels = prowLabels.labels || [];
            
            if (!validLabels.includes(label)) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `‚ùå Label \`${label}\` is not in the allowed list. Please check \`.prowlabels.yaml\` for valid labels.`
              });
              core.setFailed(`Invalid label: ${label}`);
              return;
            }
            
            // Add or remove label
            if (command === 'label') {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: [label]
              });
              core.info(`Added label ${label} to #${issueNumber}`);
            } else if (command === 'remove-label') {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: label
              });
              core.info(`Removed label ${label} from #${issueNumber}`);
            }



