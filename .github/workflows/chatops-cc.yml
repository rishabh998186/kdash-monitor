name: ChatOps CC
on:
  repository_dispatch:
    types: [cc-command, uncc-command]
permissions:
  pull-requests: write
  issues: write
jobs:
  cc:
    runs-on: ubuntu-latest
    steps:
      - name: Handle Review Request
        uses: actions/github-script@v7
        with:
          script: |
            const payload = context.payload.client_payload;
            const command = payload.slash_command.command;
            const args = payload.slash_command.args.all.trim();
            const issueNumber = payload.github.payload.issue?.number || payload.github.payload.pull_request?.number;
            const isPR = !!payload.github.payload.pull_request;
            
            if (!issueNumber) {
              core.setFailed('Could not determine issue/PR number');
              return;
            }
            
            if (!isPR) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: '‚ö†Ô∏è `/cc` command only works on pull requests, not issues.'
              });
              return;
            }
            
            // Extract username (remove @ if present)
            const username = args.replace('@', '');
            
            if (!username) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: '‚ö†Ô∏è Please specify a user to request review from. Example: `/cc @username`'
              });
              return;
            }
            
            try {
              if (command === 'cc') {
                await github.rest.pulls.requestReviewers({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: issueNumber,
                  reviewers: [username]
                });
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: `üëÄ Review requested from @${username}`
                });
                core.info(`Requested review from @${username} on PR #${issueNumber}`);
                
              } else if (command === 'uncc') {
                await github.rest.pulls.removeRequestedReviewers({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: issueNumber,
                  reviewers: [username]
                });
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: `‚ûñ Review request removed for @${username}`
                });
                core.info(`Removed review request for @${username} on PR #${issueNumber}`);
              }
            } catch (error) {
              core.setFailed(`Failed to ${command}: ${error.message}`);
              throw error;
            }
