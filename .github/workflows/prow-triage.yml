name: Prow Triage
on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  size-label:
    runs-on: ubuntu-latest
    if: github.repository == 'rishabh998186/kube-burner'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Calculate PR Size
        id: size
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          # Get additions and deletions
          DIFF_DATA=$(gh pr view "$PR_NUMBER" --repo "$REPO" --json additions,deletions)
          ADDITIONS=$(echo "$DIFF_DATA" | jq -r '.additions')
          DELETIONS=$(echo "$DIFF_DATA" | jq -r '.deletions')
          TOTAL=$((ADDITIONS + DELETIONS))
          
          echo "Total lines changed: $TOTAL"
          
          if [ $TOTAL -lt 10 ]; then
            SIZE="size/XS"
          elif [ $TOTAL -lt 30 ]; then
            SIZE="size/S"
          elif [ $TOTAL -lt 100 ]; then
            SIZE="size/M"
          elif [ $TOTAL -lt 500 ]; then
            SIZE="size/L"
          else
            SIZE="size/XL"
          fi
          
          echo "size=$SIZE" >> $GITHUB_OUTPUT

      - name: Apply Size Label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
          LABEL: ${{ steps.size.outputs.size }}
        run: |
          echo "Applying label $LABEL to PR #$PR_NUMBER"
          
          # Remove existing size labels first to avoid clutter
          EXISTING_LABELS=$(gh pr view "$PR_NUMBER" --repo "$REPO" --json labels --jq '.labels[].name' | grep "^size/" || true)
          for l in $EXISTING_LABELS; do
            if [ "$l" != "$LABEL" ]; then
              gh pr edit "$PR_NUMBER" --repo "$REPO" --remove-label "$l" || true
            fi
          done
          
          # Add the new size label
          gh pr edit "$PR_NUMBER" --repo "$REPO" --add-label "$LABEL"
