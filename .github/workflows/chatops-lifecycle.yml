name: ChatOps Lifecycle
on:
  repository_dispatch:
    types: [lifecycle-command]
permissions:
  issues: write
  pull-requests: write
jobs:
  lifecycle:
    runs-on: ubuntu-latest
    steps:
      - name: Handle Lifecycle Commands
        uses: actions/github-script@v7
        with:
          script: |
            const payload = context.payload.client_payload;
            const command = payload.slash_command.command;
            const issueNumber = payload.github.payload.issue?.number || payload.github.payload.pull_request?.number;
            const isPR = !!payload.github.payload.pull_request;
            const commenter = payload.github.payload.comment.user.login;
            
            if (!issueNumber) {
              core.setFailed('Could not determine issue/PR number');
              return;
            }
            
            try {
              switch (command) {
                case 'close':
                  await github.rest.issues.update({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    state: 'closed'
                  });
                  
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    body: `ğŸ”’ Closed by @${commenter}`
                  });
                  core.info(`Closed ${isPR ? 'PR' : 'issue'} #${issueNumber}`);
                  break;
                  
                case 'reopen':
                  await github.rest.issues.update({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    state: 'open'
                  });
                  
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    body: `ğŸ”“ Reopened by @${commenter}`
                  });
                  core.info(`Reopened ${isPR ? 'PR' : 'issue'} #${issueNumber}`);
                  break;
                  
                case 'lock':
                  await github.rest.issues.lock({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    lock_reason: 'resolved'
                  });
                  
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    body: `ğŸ” Locked by @${commenter}`
                  });
                  core.info(`Locked ${isPR ? 'PR' : 'issue'} #${issueNumber}`);
                  break;
                  
                case 'unlock':
                  await github.rest.issues.unlock({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber
                  });
                  
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    body: `ğŸ”“ Unlocked by @${commenter}`
                  });
                  core.info(`Unlocked ${isPR ? 'PR' : 'issue'} #${issueNumber}`);
                  break;
                  
                default:
                  core.setFailed(`Unknown lifecycle command: ${command}`);
              }
            } catch (error) {
              core.setFailed(`Failed to execute ${command}: ${error.message}`);
              throw error;
            }
