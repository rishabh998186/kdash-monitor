name: ChatOps Retest
on:
  repository_dispatch:
    types: [retest-command]
permissions:
  actions: write
  issues: write
  pull-requests: write
  contents: read
jobs:
  retest:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger CI Re-run
        uses: actions/github-script@v7
        with:
          script: |
            const payload = context.payload.client_payload;
            const issueNumber = payload.github.payload.issue?.number || payload.github.payload.pull_request?.number;
            const isPR = !!payload.github.payload.pull_request;
            
            if (!issueNumber) {
              core.setFailed('Could not determine issue/PR number');
              return;
            }
            
            if (!isPR) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: '‚ö†Ô∏è `/retest` command only works on pull requests.'
              });
              return;
            }
            
            try {
              // Get the PR details to find the head SHA
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: issueNumber
              });
              
              const headSha = pr.head.sha;
              const headRef = pr.head.ref;
              
              // Get all workflow runs for this PR
              const { data: workflows } = await github.rest.actions.listRepoWorkflows({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              
              // Find the CI workflow
              const ciWorkflow = workflows.workflows.find(w => 
                w.name === 'CI/CD Pipeline' || w.path.includes('ci.yml')
              );
              
              if (ciWorkflow) {
                // Trigger the workflow
                await github.rest.actions.createWorkflowDispatch({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: ciWorkflow.id,
                  ref: headRef
                });
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: `üîÑ CI tests re-triggered for commit \`${headSha.substring(0, 7)}\``
                });
                core.info(`Triggered CI workflow for PR #${issueNumber} at ${headSha}`);
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: '‚ö†Ô∏è Could not find CI workflow to trigger. Please check workflow configuration.'
                });
              }
            } catch (error) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `‚ùå Failed to trigger retest: ${error.message}`
              });
              core.setFailed(`Failed to trigger retest: ${error.message}`);
            }
