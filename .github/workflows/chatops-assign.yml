name: ChatOps Assign
on:
  repository_dispatch:
    types: [assign-command, unassign-command]
permissions:
  issues: write
  pull-requests: write
jobs:
  assign:
    runs-on: ubuntu-latest
    steps:
      - name: Handle Assign/Unassign
        uses: actions/github-script@v7
        with:
          script: |
            const payload = context.payload.client_payload;
            const command = payload.slash_command.command;
            const args = payload.slash_command.args.all.trim();
            const commenter = payload.github.payload.comment.user.login;
            const issueNumber = payload.github.payload.issue?.number || payload.github.payload.pull_request?.number;
            
            if (!issueNumber) {
              core.setFailed('Could not determine issue/PR number');
              return;
            }
            
            // Determine who to assign (self if no args, otherwise the mentioned user)
            let username = args ? args.replace('@', '') : commenter;
            
            try {
              if (command === 'assign') {
                await github.rest.issues.addAssignees({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  assignees: [username]
                });
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: `✅ Assigned to @${username}`
                });
                core.info(`Assigned @${username} to #${issueNumber}`);
                
              } else if (command === 'unassign') {
                await github.rest.issues.removeAssignees({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  assignees: [username]
                });
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: `➖ Unassigned @${username}`
                });
                core.info(`Unassigned @${username} from #${issueNumber}`);
              }
            } catch (error) {
              core.setFailed(`Failed to ${command}: ${error.message}`);
              throw error;
            }
